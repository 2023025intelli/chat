let currentChat,ws_scheme="https:"===window.location.protocol?"wss":"ws",menuLink=document.getElementById("menu-link"),userId=+document.getElementById("user-id").value,groupCreateModal=document.getElementById("group-create-modal"),groupCreateContent=document.getElementById("group-create-content"),groupCreateNameInput=document.getElementById("group-name-input"),userName=document.getElementById("user-nane").value,hostname=document.getElementById("hostname").value,chatInputBox=document.getElementById("input-box"),chatInput=document.getElementById("chat-input"),userInfoBtn=document.getElementById("user-menu-btn"),sendButton=document.getElementById("chat-send-btn"),sendIcon=document.getElementById("chat-send-icon"),headerText=document.getElementById("header-text"),searchInput=document.getElementById("search-input"),chatsBox=document.getElementById("chats-box"),searchBox=document.getElementById("search-box"),chatBox=document.getElementById("chat-box"),userWs=new ReconnectingWebSocket(ws_scheme+"://"+hostname+":8000/chat/"+userId),PRIVATETYPE=+document.getElementById("chat-type-private").value,GROUPTYPE=+document.getElementById("chat-type-group").value,CONNECTACTION=+document.getElementById("chat-action-connect").value,DISCONNECTACTION=+document.getElementById("chat-action-disconnect").value,CREATEACTION=+document.getElementById("chat-action-create").value,REMOVEACTION=+document.getElementById("chat-action-remove").value,LEAVEACTION=+document.getElementById("chat-action-leave").value;userWs.onmessage=onUserMessage;let chats=[];function setup(){let e=document.getElementsByClassName("contact"),t=document.getElementsByClassName("remove-btn"),n=document.getElementById("group-create-modal-btn"),a=document.getElementById("group-create-btn"),s=document.getElementsByClassName("modal-close");for(let t=0;t<e.length;t++)e[t].firstElementChild.addEventListener("click",openChatBox);for(let e=0;e<s.length;e++)s[e].addEventListener("click",modalClose);for(let t=0;t<e.length;t++)createChat(e[t].firstElementChild);for(let e=0;e<t.length;e++)t[e].addEventListener("click",removeContact);a.addEventListener("click",createGroup),sendButton.addEventListener("click",sendMessage),n.addEventListener("click",opencreateGroupModal),document.addEventListener("click",documentEvent)}function onUserMessage(e){let t=JSON.parse(e.data);if(t.action==CREATEACTION){let e=createContact(t.id,t.sender,t.name,t.type);createWS(e.id,t.name,t.participants),createMessageBox(e.id)}else t.action==REMOVEACTION?deleteContact(t.id):t.action==CONNECTACTION?document.getElementById("status-"+t.sender).style.fill="#19dfb1":t.action==DISCONNECTACTION&&(document.getElementById("status-"+t.sender).style.fill="#dddddd")}function documentEvent(e){let t=document.getElementsByClassName("contact-menu-btn");for(let n=0;n<t.length;n++)e.target==t[n]?e.target.firstElementChild.classList.toggle("show"):t[n].firstElementChild.classList.remove("show");e.target==userInfoBtn?e.target.firstElementChild.classList.toggle("show"):userInfoBtn.firstElementChild.classList.remove("show"),e.target.classList.contains("modal-overlay")&&(e.target.style.visibility="hidden")}function onChatMessage(e){if(obj=JSON.parse(e.data),obj.sender==userId)return;let t=document.getElementById(obj.chat),n=document.getElementById("chat-"+obj.chat),a=document.createElement("div");if(t.dataset.type==GROUPTYPE){let e=document.createElement("div");e.innerText=obj.username,e.className="chat-message-username",a.append(e)}a.append(obj.text),a.className="chat-message";let s=document.createElement("div");s.className="chat-message-time";let c=new Date(obj.date-60*(new Date).getTimezoneOffset()*1e3);s.innerText=c.getHours()+":"+("0"+c.getMinutes()).substr(-2),a.append(s),n.append(a),window.scroll(0,n.scrollHeight),moveContactUp(obj.chat)}function sendMessage(){let e=document.getElementById("chat-"+chats[currentChat].id),t=document.createElement("div"),n=document.createElement("div");t.append(chatInput.value),t.className="chat-message me",n.className="chat-message-time",t.append(n),e.append(t),window.scroll(0,e.scrollHeight),d=new Date,obj={chat:chats[currentChat].id,text:t.innerText,sender:userId,username:userName,date:Math.floor(d.getTime())+60*d.getTimezoneOffset()*1e3},n.innerText=d.getHours()+":"+("0"+d.getMinutes()).substr(-2),data=JSON.stringify(obj),chatInput.value="",chatInput.dispatchEvent(new Event("change")),chats[currentChat].ws.send(data),moveContactUp(chats[currentChat].id)}function onEent(e){chatInput.dispatchEvent(new Event("change"))}function getChat(e){for(let t=0;t<chats.length;t++)if(chats[t].id==e)return t;return-1}function opencreateGroupModal(e){groupCreateModal.style.visibility="visible"}function createGroup(e){let t=document.querySelectorAll(".group-checkbox:checked"),n=[],a=groupCreateNameInput.value.trim();for(let e=0;e<t.length;e++)n.push(+t[e].id.split("-")[1]);if(""!=a&&null!=a&&n.length>0){let e=new XMLHttpRequest;e.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let e=createContact(JSON.parse(this.responseText).id,userId,a,GROUPTYPE);createMessageBox(e.id),createWS(e.id,a,n),document.getElementById(e.id).dispatchEvent(new Event("click"))}},e.open("POST","/api/chat/create",!0),e.setRequestHeader("Content-type","application/json");let t=JSON.stringify({participants:n,name:a,type:GROUPTYPE});e.send(t),resetGroupCreateModal()}}function openChatBox(e){let t=e.target.id;searchBox.innerHTML="";let n=document.getElementsByClassName("chat-messages");for(let e=0;e<n.length;e++)n[e].id=="chat-"+t?(document.getElementById(t).parentElement.classList.add("contact-active"),(currentChat=getChat(t))>=0&&(headerText.innerText=chats[currentChat].name,n[e].style.display="flex",chatInputBox.style.display="flex",chatInput.value=chats[currentChat].message),onEent(),resetSearch()):(document.getElementById(n[e].id.split("-")[1]).parentElement.classList.remove("contact-active"),n[e].style.display="none")}function addToChats(e,t){let n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let n=createContact(JSON.parse(this.responseText).id,e,t);createMessageBox(n.id),createWS(n.id,t,[+e]),document.getElementById(n.id).dispatchEvent(new Event("click"))}};let a=JSON.stringify({name:userName,participants:[+e]});n.open("POST","/api/chat/create",!0),n.setRequestHeader("Content-type","application/json"),n.send(a)}function createContact(e,t,n,a=PRIVATETYPE){let s=document.createElement("div"),c=document.createElement("a"),o=document.createElement("div"),d=document.createElement("div"),l=document.createElement("span");if(s.className="contact",o.className="contact-menu-btn col-2",c.classList.add("contact-link"),c.dataset.userId=t,c.dataset.type=a,c.innerText=n,c.href="#"+n,c.id=e,c.addEventListener("click",openChatBox),d.className="contact-menu-dropdown",d.id="menu-"+e,a==GROUPTYPE){let e=document.createElement("span");e.className="contact-menu-entry info-btn",e.innerText="Info",d.append(e)}l.className="contact-menu-entry remove-btn",l.innerText=a==PRIVATETYPE?"Remove":t==userId?"Remove":"Leave Group",l.addEventListener("click",removeContact);let r=document.createElement("div");if(a==PRIVATETYPE){c.classList.add("col-9"),r.className="col-1",r.innerHTML=`<svg id="status-${t}" viewBox="0 0 100 100" style="width: 0.4rem; height: 0.4rem"\n             xmlns="http://www.w3.org/2000/svg" fill="#dddddd">\n                <circle cx="50" cy="50" r="50"></circle>\n             </svg>`;let e=document.createElement("div");e.className="checkbox-container",e.id="contact-"+t,e.innerHTML=`<input id="check-${t}" type="checkbox" class="custom-checkbox group-checkbox">\n            <label for="check-${t}" class="checkbox-label"\n                   style="flex-grow: 1">${n}</label>`,groupCreateContent.append(e)}else c.classList.add("col-10");return d.append(l),o.append(d),s.append(c),a==PRIVATETYPE&&s.append(r),s.append(o),chatsBox.append(s),c}function removeContact(e){let t=e.target.parentElement.id.split("-")[1];sendRemoveUserMessage(t),deleteContact(t)}function deleteContact(e){let t=getChat(e),n=document.getElementById(e);n.dataset.type==PRIVATETYPE&&document.getElementById("contact-"+n.dataset.userId).remove(),t>=0&&(chats.splice(t,1),document.getElementById(e).innerText==headerText.innerText&&(headerText.innerText="...",chatInputBox.style.display="none"),document.getElementById(e).parentElement.remove(),document.getElementById("chat-"+e).remove())}function sendRemoveUserMessage(e){let t=new XMLHttpRequest,n=JSON.stringify({id:e});t.open("POST","/api/chat/remove",!0),t.setRequestHeader("Content-type","application/json"),t.send(n)}function moveContactUp(e){let t=document.getElementById(e).parentElement;chatsBox.removeChild(t),chatsBox.prepend(t)}function createChat(e){createWS(e.id,e.innerText,[+e.dataset.userId])}function createWS(e,t,n=null){let a={id:+e,name:t,message:"",participants:n};a.ws=new ReconnectingWebSocket(ws_scheme+"://"+hostname+":8000/chat/"+userId+"/"+a.id),a.ws.onmessage=onChatMessage,a.ws.onopen=onEent,a.ws.onerror=onEent,a.ws.onclose=onEent,chats.push(a)}function createMessageBox(e){let t=document.createElement("div");t.style.display="none",t.id="chat-"+e,t.className="chat-messages",chatBox.append(t)}function chatInputChange(e){let t=e.target.value.trim();chats[currentChat].message=t,""!==t&&null!=t&&chats[currentChat].ws.readyState===WebSocket.OPEN?(sendButton.disabled=!1,sendIcon.setAttribute("fill","#44a2ff")):(sendButton.disabled=!0,sendIcon.setAttribute("fill","#B3B7BB"))}function onEnterPress(e){if("Enter"===e.key){e.preventDefault();let t=e.target.value.trim();""!==t&&null!=t&&chats[currentChat].ws.readyState===WebSocket.OPEN&&sendMessage()}}function resetGroupCreateModal(){groupCreateNameInput.value="",groupCreateModal.style.visibility="hidden";let e=document.querySelectorAll(".group-checkbox:checked");for(let t=0;t<e.length;t++)e[t].checked=!1}function resetSearch(){searchBox.innerHTML="",searchBox.style.display="none",chatsBox.style.display="flex",searchInput.value=""}function searchEvent(e){if(e.target.value.length>0){let t=new XMLHttpRequest;chatsBox.style.display="none",searchBox.style.display="flex",t.onreadystatechange=function(){if(4==this.readyState&&200==this.status){searchBox.innerHTML="";let e=JSON.parse(this.responseText);for(let t=0;t<e.length;t++){let n=document.createElement("a");n.className="contact contact-link",n.innerText=e[t].username,n.href="#"+e[t].username,n.id=e[t].id,n.addEventListener("click",searchForChat),searchBox.append(n)}}},t.open("GET","/api/user/search?q="+e.target.value,!0),t.send()}else chatsBox.style.display="flex",searchBox.style.display="none"}function searchForChat(e){let t=e.target.id,n=e.target.innerText,a=document.getElementsByClassName("contact-link");for(let e=0;e<a.length;e++)if(a[e].dataset.type==PRIVATETYPE&&a[e].dataset.userId==t)return void document.getElementById(a[e].id).dispatchEvent(new Event("click"));addToChats(t,n)}function modalClose(e){e.target.closest(".modal-overlay").style.visibility="hidden"}function getElements(){return{sidebar:document.getElementById("sidebar"),wrapper:document.getElementById("wrapper"),header:document.getElementById("header"),input:document.getElementById("input-box")}}function toggleAll(){let e=getElements();e.wrapper.classList.toggle("active"),e.header.classList.toggle("active"),e.sidebar.classList.toggle("active"),e.input.classList.toggle("active")}function handleEvent(e){e.preventDefault(),toggleAll()}searchInput.addEventListener("input",searchEvent),chatInput.addEventListener("keydown",onEnterPress),chatInput.addEventListener("input",chatInputChange),chatInput.addEventListener("change",chatInputChange),menuLink.addEventListener("click",handleEvent);