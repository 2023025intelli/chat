let currentChat,ws_scheme="https:"===window.location.protocol?"wss":"ws",menuLink=document.getElementById("menu-link"),userId=document.getElementById("user-id").value,userName=document.getElementById("user-nane").value,hostname=document.getElementById("hostname").value,chatInputBox=document.getElementById("input-box"),chatInput=document.getElementById("chat-input"),sendButton=document.getElementById("chat-send-btn"),sendIcon=document.getElementById("chat-send-icon"),headerText=document.getElementById("header-text"),searchInput=document.getElementById("search-input"),contactBox=document.getElementById("contact-box"),searchBox=document.getElementById("search-box"),chatBox=document.getElementById("chat-box"),userWs=new ReconnectingWebSocket(ws_scheme+"://"+hostname+":8000/chat/"+userId);userWs.onmessage=onUserMessage;let chats=[];function setup(){let e=document.getElementsByClassName("contact"),t=document.getElementsByClassName("remove");for(let t=0;t<e.length;t++)e[t].firstElementChild.addEventListener("click",openChatBox);for(let t=0;t<e.length;t++)createChat(e[t].firstElementChild);for(let e=0;e<t.length;e++)t[e].addEventListener("click",removeContact);sendButton.addEventListener("click",sendMessage),document.addEventListener("click",contactMenuEvent)}function onChatMessage(e){if(obj=JSON.parse(e.data),obj.sender==userId)return;let t=document.getElementById("chat-"+obj.sender),n=document.createElement("div");n.innerText=obj.text,n.className="chat-message";let a=document.createElement("div");a.className="chat-message-time";let s=new Date(obj.date-60*(new Date).getTimezoneOffset()*1e3);a.innerText=s.getHours()+":"+("0"+s.getMinutes()).substr(-2),n.append(a),t.append(n),window.scroll(0,t.scrollHeight),moveContactUp(obj.sender)}function onUserMessage(e){let t=JSON.parse(e.data);if("create"==t.action){let e=createContact(t.sender,t.name);createWS(t.sender,t.name),createMessageBox(e.id)}else"remove"==t.action?deleteContact(t.sender):"connect"==t.action?document.getElementById("status-"+t.sender).style.fill="#19dfb1":"disconnect"==t.action&&(document.getElementById("status-"+t.sender).style.fill="#dddddd")}function contactMenuEvent(e){if(e.target.classList.contains("contact-menu-btn"))e.target.firstElementChild.classList.toggle("show");else{let e=document.getElementsByClassName("contact-menu-dropdown");for(let t=0;t<e.length;t++)e[t].classList.remove("show")}}function onEent(e){chatInput.dispatchEvent(new Event("change"))}function getChat(e){for(let t=0;t<chats.length;t++)if(chats[t].id==e)return t;return-1}function openChatBox(e){let t=e.target.id,n=e.target.innerText;searchBox.innerHTML="";let a=document.getElementsByClassName("chat-messages"),s=!1;for(let e=0;e<a.length;e++)a[e].id=="chat-"+t?(document.getElementById(t).parentElement.classList.add("contact-active"),currentChat=getChat(t),chatInput.value=chats[currentChat].message,headerText.innerText=chats[currentChat].name,a[e].style.display="flex",chatInputBox.style.display="flex",onEent(),resetSearch(),s=!0):(document.getElementById(a[e].id.split("-")[1]).parentElement.classList.remove("contact-active"),a[e].style.display="none");s||(createMessageBox(t),createWS(t,n),addToChats(t,n),document.getElementById(t).dispatchEvent(new Event("click")))}function addToChats(e,t){let n=new XMLHttpRequest,a=JSON.stringify({sender:userId,receiver:e,name:userName,action:"create"});userWs.send(a),createContact(e,t),n.open("POST","/api/chat/create",!0),n.setRequestHeader("Content-type","application/json"),n.send(e)}function createContact(e,t){let n=document.createElement("div"),a=document.createElement("a"),s=document.createElement("div"),c=document.createElement("div"),o=document.createElement("a"),d=document.createElement("div");return n.className="contact",s.className="contact-menu-btn col-2",a.className="contact-link col-9",a.innerText=t,a.href="#"+t,a.id=e,a.addEventListener("click",openChatBox),c.className="contact-menu-dropdown",c.id=e+"-menu",o.className="contact-menu-entry remove",o.href="#remove",o.innerText="Remove",o.addEventListener("click",removeContact),d.className="col-1",d.innerHTML=`<div class="col-1">\n            <svg id="status-${e}" viewBox="0 0 100 100" style="width: 0.4rem; height: 0.4rem"\n                 xmlns="http://www.w3.org/2000/svg" fill="#dddddd">\n                <circle cx="50" cy="50" r="50"></circle>\n            </svg>\n        </div>`,c.append(o),s.append(c),n.append(a),n.append(d),n.append(s),contactBox.append(n),a}function removeContact(e){id=e.target.parentElement.id.split("-")[0],deleteContact(id)}function deleteContact(e){index=getChat(e),chats.splice(index,1),document.getElementById(e).innerText==headerText.innerText&&(headerText.innerText="...",chatInputBox.style.display="none"),document.getElementById(e).parentElement.remove(),document.getElementById("chat-"+e).remove();let t=new XMLHttpRequest;t.open("POST","/api/chat/remove",!0),t.setRequestHeader("Content-type","application/json"),t.send(e);let n=JSON.stringify({sender:userId,receiver:e,name:userName,action:"remove"});userWs.send(n)}function moveContactUp(e){let t=document.getElementById(e).parentElement;contactBox.removeChild(t),contactBox.prepend(t)}function createChat(e){createWS(e.id,e.innerText)}function createWS(e,t){obj={id:e,name:t,room:e<userId?e.toString()+userId:userId+e,message:""},obj.ws=new ReconnectingWebSocket(ws_scheme+"://"+hostname+":8000/chat/"+userId+"/"+obj.room),obj.ws.onmessage=onChatMessage,obj.ws.onopen=onEent,obj.ws.onerror=onEent,obj.ws.onclose=onEent,chats.push(obj)}function createMessageBox(e){let t=document.createElement("div");t.className="chat-messages",t.id="chat-"+e,chatBox.append(t)}function sendMessage(){let e=document.getElementById("chat-"+chats[currentChat].id),t=document.createElement("div"),n=document.createElement("div");t.innerText=chatInput.value,t.className="chat-message me",n.className="chat-message-time",t.append(n),e.append(t),window.scroll(0,e.scrollHeight),d=new Date,obj={text:t.innerText,sender:userId,receiver:chats[currentChat].id,date:Math.floor(d.getTime())+60*d.getTimezoneOffset()*1e3},n.innerText=d.getHours()+":"+("0"+d.getMinutes()).substr(-2),data=JSON.stringify(obj),chatInput.value="",chatInput.dispatchEvent(new Event("change")),chats[currentChat].ws.send(data),moveContactUp(chats[currentChat].id)}function chatInputChange(e){chats[currentChat].message=e.target.value,""!==e.target.value&&null!=e.target.value&&chats[currentChat].ws.readyState===WebSocket.OPEN?(sendButton.disabled=!1,sendIcon.setAttribute("fill","#1A8EFF")):(sendButton.disabled=!0,sendIcon.setAttribute("fill","#B3B7BB"))}function onEnterPress(e){"Enter"===e.key&&(e.preventDefault(),""!==e.target.value&&null!=e.target.value&&chats[currentChat].ws.readyState===WebSocket.OPEN&&sendMessage())}function resetSearch(){searchBox.innerHTML="",searchBox.style.display="none",contactBox.style.display="flex",searchInput.value=""}function searchEvent(e){if(e.target.value.length>2){let t=new XMLHttpRequest;contactBox.style.display="none",searchBox.style.display="flex",t.onreadystatechange=function(){if(4==this.readyState&&200==this.status){searchBox.innerHTML="";let e=JSON.parse(this.responseText);for(let t=0;t<e.length;t++){let n=document.createElement("a");n.className="contact contact-link",n.innerText=e[t].username,n.href="#"+e[t].username,n.id=e[t].id,n.addEventListener("click",openChatBox),searchBox.append(n)}}},t.open("GET","/api/user/search?q="+e.target.value,!0),t.send()}else contactBox.style.display="flex",searchBox.style.display="none"}function getElements(){return{sidebar:document.getElementById("sidebar"),wrapper:document.getElementById("wrapper"),header:document.getElementById("header"),input:document.getElementById("input-box")}}function toggleAll(){let e=getElements();e.wrapper.classList.toggle("active"),e.header.classList.toggle("active"),e.sidebar.classList.toggle("active"),e.input.classList.toggle("active")}function handleEvent(e){e.preventDefault(),toggleAll()}searchInput.addEventListener("input",searchEvent),chatInput.addEventListener("keydown",onEnterPress),chatInput.addEventListener("input",chatInputChange),chatInput.addEventListener("change",chatInputChange),menuLink.addEventListener("click",handleEvent);